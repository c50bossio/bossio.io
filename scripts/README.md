# 🚀 Bossio.io Deployment Scripts

This directory contains production deployment scripts for the bossio.io barbershop booking system.

## 📋 Available Scripts

### 🔧 Setup Scripts

#### `setup-stripe-products.ts`
Creates all necessary Stripe products and prices for the platform.

```bash
npm run setup:stripe
# or
npx tsx scripts/setup-stripe-products.ts
```

**What it does:**
- Creates AI Business Coaching product ($0.04 per 1K tokens)
- Creates SMS Notifications product ($0.01 per message)  
- Creates Enterprise Plan product ($499/month)
- Sets up webhook endpoints for payment processing
- Generates environment variables for your `.env` file

**Required Environment Variables:**
- `STRIPE_SECRET_KEY` - Your Stripe secret key
- `NEXT_PUBLIC_APP_URL` - Your app URL for webhooks

### ✅ Verification Scripts

#### `deployment-checklist.ts`
Comprehensive deployment readiness checker.

```bash
npm run deployment:check
# or
npx tsx scripts/deployment-checklist.ts

# Generate environment template
npm run deployment:check:template
# or
npx tsx scripts/deployment-checklist.ts --template
```

**What it checks:**
- ✅ All required environment variables
- ⚠️ Optional service configurations
- 📁 Critical file structure
- 🏥 Basic health checks
- 📊 Configuration completeness percentage

#### `test-api-connections.ts`
Tests all external API connections.

```bash
npm run test:apis
# or
npx tsx scripts/test-api-connections.ts

# Verbose mode with detailed responses
npm run test:apis:verbose
# or
npx tsx scripts/test-api-connections.ts --verbose
```

**Services tested:**
- 🗄️ PostgreSQL database (Neon)
- 💳 Stripe payment processing
- 📱 Twilio SMS service
- 📧 SendGrid email service
- ☁️ Cloudflare R2 storage
- 🤖 OpenAI API service

## 🔄 Deployment Workflow

### 1. Initial Setup

```bash
# Install dependencies
npm install

# Generate database schema
npm run db:generate

# Set up Stripe products (production)
npm run setup:stripe
```

### 2. Pre-Deployment Verification

```bash
# Check deployment readiness
npm run deployment:check

# Test all API connections
npm run test:apis

# Generate environment template if needed
npm run deployment:check:template
```

### 3. Database Migration

```bash
# Run migrations
npm run db:migrate

# Optional: Open database studio
npm run db:studio
```

### 4. Vercel Deployment

```bash
# Deploy to production
vercel --prod

# Add environment variables
vercel env add

# Add custom domain
vercel domains add yourdomain.com
```

## 📊 Environment Variables

### Required for Core Functionality

```env
# Core Application
NEXT_PUBLIC_APP_URL=https://bossio.io
DATABASE_URL=postgres://user:pass@host:5432/db
BETTER_AUTH_SECRET=your-secret-key-32-chars-min

# Stripe Payments (Required)
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PUBLIC_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

### Optional Services

```env
# Google OAuth
GOOGLE_CLIENT_ID=your-client-id.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret

# Stripe Product IDs (Generated by setup:stripe)
STRIPE_AI_PRICE_ID=price_...
STRIPE_SMS_PRICE_ID=price_...
STRIPE_ENTERPRISE_PRICE_ID=price_...

# Twilio SMS
TWILIO_ACCOUNT_SID=AC...
TWILIO_AUTH_TOKEN=your-auth-token
TWILIO_PHONE_NUMBER=+1234567890

# SendGrid Email
SENDGRID_API_KEY=SG...
SENDGRID_FROM_EMAIL=notifications@bossio.io
SENDGRID_FROM_NAME=BookedBarber

# Cloudflare R2 Storage
R2_UPLOAD_IMAGE_ACCESS_KEY_ID=your-access-key
R2_UPLOAD_IMAGE_SECRET_ACCESS_KEY=your-secret-key
CLOUDFLARE_ACCOUNT_ID=your-account-id
R2_UPLOAD_IMAGE_BUCKET_NAME=images

# OpenAI API
OPENAI_API_KEY=sk-...

# Security
CRON_SECRET=your-random-secret-here
```

## 🛠️ Database Management

### Schema Generation
```bash
npm run db:generate
```
Generates new migration files based on schema changes.

### Database Migration
```bash
npm run db:migrate
```
Applies pending migrations to the database.

### Database Studio
```bash
npm run db:studio
```
Opens Drizzle Studio for visual database management.

## 🔍 Troubleshooting

### Common Issues

#### "Missing required environment variables"
Run the deployment checklist to see what's missing:
```bash
npm run deployment:check
```

#### "Stripe webhook verification failed"
1. Ensure `STRIPE_WEBHOOK_SECRET` is set correctly
2. Check webhook endpoint is accessible: `https://yourdomain.com/api/stripe/webhook`
3. Verify webhook events are configured in Stripe dashboard

#### "Database connection failed"
1. Check `DATABASE_URL` format: `postgres://user:pass@host:5432/dbname`
2. Verify database is accessible from deployment environment
3. Run migrations: `npm run db:migrate`

#### "SMS/Email services not working"
1. Verify API keys with: `npm run test:apis`
2. Check service-specific configuration in provider dashboard
3. Ensure webhook endpoints are configured if required

### Debug Mode

Run scripts with verbose output:
```bash
npm run test:apis:verbose
npm run deployment:check -- --verbose
```

## 📈 Production Monitoring

After deployment, monitor these key metrics:

### Health Endpoints
- `/api/health` - Application health check
- `/api/stripe/webhook` - Payment webhook status

### Key Metrics to Watch
- 🔄 Appointment booking completion rate
- 💳 Payment processing success rate  
- 📱 SMS delivery success rate
- 📧 Email delivery success rate
- ⚡ API response times
- 🗄️ Database connection health

## 🚨 Emergency Procedures

### Service Outage
1. Check Vercel deployment status
2. Verify external service status (Stripe, Twilio, etc.)
3. Check database connectivity
4. Review error logs in Vercel dashboard

### Payment Issues
1. Check Stripe dashboard for failed payments
2. Verify webhook endpoint accessibility
3. Check payment processing logs
4. Contact Stripe support if needed

### Data Loss Prevention
1. Database backups are handled by Neon automatically
2. File uploads stored in Cloudflare R2 with versioning
3. Critical configurations stored in version control

## 📞 Support

For deployment issues:
1. Check this README first
2. Run diagnostic scripts
3. Review Vercel and service provider logs
4. Check environment variable configuration

---

## 🎯 Quick Start Checklist

- [ ] Clone repository
- [ ] Run `npm install`
- [ ] Copy `.env.example` to `.env.local`
- [ ] Configure required environment variables
- [ ] Run `npm run deployment:check`
- [ ] Run `npm run setup:stripe` (production only)
- [ ] Run `npm run test:apis`
- [ ] Deploy with `vercel --prod`
- [ ] Configure production environment variables
- [ ] Test production deployment

**🎉 Your barbershop booking platform is ready to serve customers!**